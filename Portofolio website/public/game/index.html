<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <img src="frame.png"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; object-fit: stretch;">
    <div id="qrcode" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20;">
    </div>

    <script>
        let peer;
        let playerX, playerY;
        let tiltX = 0, tiltY = 0;
        let detectedColor = "white";

        function setup() {
            createCanvas(windowWidth, windowHeight);
            playerX = width / 2;
            playerY = height / 2;
            textAlign(CENTER, CENTER);

            peer = new Peer();

            peer.on('open', (id) => {

                const baseUrl = 'https://www.costinsarghiuta.com/game/';
                let controllerURL = baseUrl + 'controller.html?hostId=' + id;

                new QRCode(document.getElementById("qrcode"), {
                    text: controllerURL,
                    width: 128,
                    height: 128
                });
            });

            peer.on('connection', (conn) => {
                document.getElementById("qrcode").style.display = "none";
                conn.on('data', (data) => {
                    if (data.tiltX !== undefined) tiltX = data.tiltX;
                    if (data.tiltY !== undefined) tiltY = data.tiltY;
                    if (data.color) detectedColor = data.color;
                });
            });
        }

        function draw() {
            if (detectedColor === 'Red') background(255, 200, 200);
            else if (detectedColor === 'Blue') background(200, 200, 255);
            else background(220);

            fill(0);
            text("Scan QR to play!", width / 2, 50);

            playerX += tiltX * 0.5;
            playerY += tiltY * 0.5;

            playerX = constrain(playerX, 80, width - 70);
            playerY = constrain(playerY, 80, height - 80);

            fill(50, 150, 255);
            ellipse(playerX, playerY, 50, 50);
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }
    </script>
</body>

</html>