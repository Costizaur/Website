<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            overflow: hidden;
            touch-action: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>

<body>
    <script>
        let peer, conn;
        let statusLabel = 'Connecting...';

        let inputs = { left: false, right: false };
        let myColor = '#ccc';

        function setup() {

            let w = max(windowWidth, windowHeight);
            let h = min(windowWidth, windowHeight);
            createCanvas(w, h);
            textAlign(CENTER, CENTER);
            textSize(30);

            const urlParams = new URLSearchParams(window.location.search);
            const hostId = urlParams.get('hostId');

            if (!hostId) { statusLabel = "Error: No Host ID."; return; }

            peer = new Peer();
            peer.on('open', (id) => {
                conn = peer.connect(hostId);

                conn.on('open', () => {
                    statusLabel = "Connected! Waiting for Player 2...";

                    conn.send({ type: 'handshake' });
                });


                conn.on('data', (data) => {
                    if (data.type === 'assignColor') {
                        myColor = data.color;
                        statusLabel = "READY!";
                    }
                    if (data.type === 'gameStart') {
                        statusLabel = "";
                    }
                });
            });
        }

        function draw() {
            background(220);


            if (statusLabel !== "") {
                fill(0);
                text(statusLabel, width / 2, height / 2);
                text("Please rotate phone to landscape", width / 2, height / 2 + 50);
                return;
            }



            inputs.left = false;
            inputs.right = false;


            for (let i = 0; i < touches.length; i++) {

                if (touches[i].x < width / 2) {
                    inputs.left = true;
                }

                else {
                    inputs.right = true;
                }
            }


            if (conn && conn.open) {

                conn.send({ type: 'input', left: inputs.left, right: inputs.right });
            }


            noStroke();

            if (inputs.left) fill(myColor); else fill(100);
            rect(0, 0, width / 2, height);


            if (inputs.right) fill(myColor); else fill(150);
            rect(width / 2, 0, width / 2, height);


            stroke(255); strokeWeight(5);
            line(width / 2, 0, width / 2, height);


            fill(255); noStroke();
            text("L", width / 4, height / 2);
            text("R", width * 3 / 4, height / 2);
        }


        function windowResized() {
            let w = max(windowWidth, windowHeight);
            let h = min(windowWidth, windowHeight);
            resizeCanvas(w, h);
        }

        function touchStarted() { return false; }
        function touchMoved() { return false; }
        function touchEnded() { return false; }
    </script>
</body>

</html>